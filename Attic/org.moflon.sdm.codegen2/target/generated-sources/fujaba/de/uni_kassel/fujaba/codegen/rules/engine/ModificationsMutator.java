/*
 * generated by Fujaba - CodeGen2
 */
package de.uni_kassel.fujaba.codegen.rules.engine;
import java.util.Iterator;
import java.util.Set;

import de.uni_kassel.fujaba.codegen.rules.ExecuteStoryPatternOperation;
import de.uni_kassel.fujaba.codegen.rules.MutatingOperation;
import de.uni_kassel.fujaba.codegen.rules.MutatorBlock;
import de.uni_kassel.fujaba.codegen.rules.Token;
import de.upb.tools.sdm.JavaSDM; // requires Fujaba5/libs/RuntimeTools.jar in classpath
import de.upb.tools.sdm.JavaSDMException;


public class ModificationsMutator extends PlanMutator
{


   protected boolean addOperation (ExecuteStoryPatternOperation plan , Token operation , Token parent )
   {
      boolean fujaba__Success = false;
      Set deps = null;
      Token tmpParent = null;
      Iterator fujaba__IterDepsToDep = null;
      Object _TmpObject = null;
      Token dep = null;

      // story pattern successor
      try 
      {
         fujaba__Success = false; 

         deps = getDependencies (plan, operation);

         // check object deps is really bound
         JavaSDM.ensure ( deps != null );
         fujaba__Success = true;
      }
      catch ( JavaSDMException fujaba__InternalException )
      {
         fujaba__Success = false;
      }

      // story pattern successor
      try 
      {
         fujaba__Success = false; 

         // check object deps is really bound
         JavaSDM.ensure ( deps != null );
         // iterate to-many link contains from deps to dep
         fujaba__Success = false;
         fujaba__IterDepsToDep = deps.iterator ();

         while ( fujaba__IterDepsToDep.hasNext () )
         {
            try
            {
               _TmpObject =  fujaba__IterDepsToDep.next ();

               // ensure correct type and really bound of object dep
               JavaSDM.ensure ( _TmpObject instanceof Token );
               dep = (Token) _TmpObject;

               // story pattern successor
               try 
               {
                  fujaba__Success = false; 

                  // check object dep is really bound
                  JavaSDM.ensure ( dep != null );
                  // search to-one link children from dep to tmpParent
                  tmpParent = dep.getParent ();

                  // check object tmpParent is really bound
                  JavaSDM.ensure ( tmpParent != null );

                  // check isomorphic binding between objects tmpParent and dep
                  JavaSDM.ensure ( !tmpParent.equals (dep) );


                  fujaba__Success = true;
               }
               catch ( JavaSDMException fujaba__InternalException )
               {
                  fujaba__Success = false;
               }

               if ( !( fujaba__Success ) )
               {
                  return false;

               }

               fujaba__Success = true;
            }
            catch ( JavaSDMException fujaba__InternalException )
            {
               fujaba__Success = false;
            }
         }
         JavaSDM.ensure (fujaba__Success);
         fujaba__Success = true;
      }
      catch ( JavaSDMException fujaba__InternalException )
      {
         fujaba__Success = false;
      }

      try 
      {
         fujaba__Success = false; 

         // check object operation is really bound
         JavaSDM.ensure ( operation != null );
         // check object parent is really bound
         JavaSDM.ensure ( parent != null );
         // check isomorphic binding between objects parent and operation
         JavaSDM.ensure ( !parent.equals (operation) );

         // create link children from operation to parent
         operation.setParent (parent);

         fujaba__Success = true;
      }
      catch ( JavaSDMException fujaba__InternalException )
      {
         fujaba__Success = false;
      }

      return true;
   }

   public Set getDependencies (ExecuteStoryPatternOperation plan , Token op )
   {
      boolean fujaba__Success = false;
      ExecutionPlanEngine engine = null;
      Set deps = null;

      // story pattern successor
      try 
      {
         fujaba__Success = false; 

         // search to-one link mutators from this to engine
         engine = this.getEngine ();

         // check object engine is really bound
         JavaSDM.ensure ( engine != null );


         fujaba__Success = true;
      }
      catch ( JavaSDMException fujaba__InternalException )
      {
         fujaba__Success = false;
      }

      // story pattern storypatternwiththis
      try 
      {
         fujaba__Success = false; 

         deps = engine.getSequentialDependencies (plan, op);

         // check object deps is really bound
         JavaSDM.ensure ( deps != null );
         fujaba__Success = true;
      }
      catch ( JavaSDMException fujaba__InternalException )
      {
         fujaba__Success = false;
      }

      return deps;
   }

   public void mutate (ExecuteStoryPatternOperation plan )
   {
      boolean fujaba__Success = false;
      Iterator fujaba__IterPlanToMutatorBlock = null;
      Object _TmpObject = null;
      MutatorBlock mutatorBlock = null;
      Token parent = null;
      int count = 0;
      Iterator fujaba__IterPlanToOperation = null;
      Token operation = null;
      int last = 0;

      // story pattern 
      try 
      {
         fujaba__Success = false; 

         // check object plan is really bound
         JavaSDM.ensure ( plan != null );
         // iterate to-many link operations from plan to mutatorBlock
         fujaba__Success = false;
         fujaba__IterPlanToMutatorBlock = plan.iteratorOfOperations ();

         while ( !(fujaba__Success) && fujaba__IterPlanToMutatorBlock.hasNext () )
         {
            try
            {
               _TmpObject =  fujaba__IterPlanToMutatorBlock.next ();

               // ensure correct type and really bound of object mutatorBlock
               JavaSDM.ensure ( _TmpObject instanceof MutatorBlock );
               mutatorBlock = (MutatorBlock) _TmpObject;


               fujaba__Success = true;
            }
            catch ( JavaSDMException fujaba__InternalException )
            {
               fujaba__Success = false;
            }
         }
         JavaSDM.ensure (fujaba__Success);
         fujaba__Success = true;
      }
      catch ( JavaSDMException fujaba__InternalException )
      {
         fujaba__Success = false;
      }

      // story pattern 
      try 
      {
         fujaba__Success = false; 

         // check object mutatorBlock is really bound
         JavaSDM.ensure ( mutatorBlock != null );
         // search to-one link children from mutatorBlock to parent
         parent = mutatorBlock.getParent ();

         // check object parent is really bound
         JavaSDM.ensure ( parent != null );

         // check isomorphic binding between objects parent and mutatorBlock
         JavaSDM.ensure ( !parent.equals (mutatorBlock) );


         fujaba__Success = true;
      }
      catch ( JavaSDMException fujaba__InternalException )
      {
         fujaba__Success = false;
      }

      if ( !( fujaba__Success ) )
      {
         // story pattern Successor of 
         try 
         {
            fujaba__Success = false; 

            // check object mutatorBlock is really bound
            JavaSDM.ensure ( mutatorBlock != null );
            // check object plan is really bound
            JavaSDM.ensure ( plan != null );
            // check link operations from mutatorBlock to plan
            JavaSDM.ensure (plan.equals (mutatorBlock.getStoryPatternOperation ()));

            // create link children from mutatorBlock to plan
            mutatorBlock.setParent (plan);

            fujaba__Success = true;
         }
         catch ( JavaSDMException fujaba__InternalException )
         {
            fujaba__Success = false;
         }


      }
      do
      {
         // story pattern 
         try 
         {
            fujaba__Success = false; 

            // collabStat call
            count = 0;
            fujaba__Success = true;
         }
         catch ( JavaSDMException fujaba__InternalException )
         {
            fujaba__Success = false;
         }

         // story pattern storypatternwiththis
         try 
         {
            fujaba__Success = false; 

            // check object plan is really bound
            JavaSDM.ensure ( plan != null );
            // iterate to-many link operations from plan to operation
            fujaba__Success = false;
            fujaba__IterPlanToOperation = plan.iteratorOfOperations ();

            while ( fujaba__IterPlanToOperation.hasNext () )
            {
               try
               {
                  _TmpObject =  fujaba__IterPlanToOperation.next ();

                  // ensure correct type and really bound of object operation
                  JavaSDM.ensure ( _TmpObject instanceof Token );
                  operation = (Token) _TmpObject;

                  // check negative bindings
                  try
                  {
                     fujaba__Success = false;

                     // search to-one link children from operation to parent
                     parent = operation.getParent ();

                     // check object parent is really bound
                     JavaSDM.ensure ( parent != null );

                     // check isomorphic binding between objects parent and operation
                     JavaSDM.ensure ( !parent.equals (operation) );



                     fujaba__Success = true;
                  }
                  catch ( JavaSDMException fujaba__InternalException )
                  {
                     fujaba__Success = false;
                  }

                  fujaba__Success = !(fujaba__Success);

                  JavaSDM.ensure ( fujaba__Success );

                  // check isomorphic binding between objects plan and operation
                  JavaSDM.ensure ( !plan.equals (operation) );

                  // constraint operation instanceof MutatingOperation
                  JavaSDM.ensure ( operation instanceof MutatingOperation );
                  // collabStat call
                  count = count + 1;
                  // collabStat call
                  addOperation (plan, operation, mutatorBlock);

                  fujaba__Success = true;
               }
               catch ( JavaSDMException fujaba__InternalException )
               {
                  fujaba__Success = false;
               }
            }
            JavaSDM.ensure (fujaba__Success);
            fujaba__Success = true;
         }
         catch ( JavaSDMException fujaba__InternalException )
         {
            fujaba__Success = false;
         }

         // story pattern successor
         try 
         {
            fujaba__Success = false; 

            // constraint (last == 0) || (count < last)
            JavaSDM.ensure ( (last == 0) || (count < last) );
            // constraint count > 0
            JavaSDM.ensure ( count > 0 );
            // collabStat call
            last = count;
            fujaba__Success = true;
         }
         catch ( JavaSDMException fujaba__InternalException )
         {
            fujaba__Success = false;
         }


      }
      while ( fujaba__Success );return ;
   }

}


